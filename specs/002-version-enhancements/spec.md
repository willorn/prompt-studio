# Feature Specification: 版本增强功能集

**Feature Branch**: `002-version-enhancements`  
**Created**: 2025-11-16  
**Status**: Draft  
**Input**: User description: "版本增强功能集：对比、去重、拖动分隔、非叶子版本保存、版本搜索、UI优化"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 版本对比 (Priority: P1)

用户在优化Prompt的过程中，需要对比不同版本之间的变化，以了解哪些修改带来了效果提升，哪些修改需要回退。用户选择一个版本，点击"对比"按钮，从弹出的版本列表中选择另一个版本，然后在全屏对比模态框中查看两个版本的并排Diff视图，清晰地看到增删改的内容。

**Why this priority**: 版本对比是版本管理工具的核心功能，直接关系到用户能否有效追踪和理解Prompt的演化过程。这是当前PRD评估中标识的高优先级缺失功能。

**Independent Test**: 可以通过创建两个内容不同的版本，选中其中一个点击对比，选择另一个版本，验证对比模态框是否正确展示差异来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在版本树中选中了某个版本, **When** 用户点击右侧面板的"对比"按钮, **Then** 系统弹出版本选择对话框，显示当前项目的所有版本列表（不包括当前已选中的版本）
2. **Given** 版本选择对话框已打开, **When** 用户从列表中选择另一个版本并确认, **Then** 系统打开全屏对比模态框，左右并排显示两个版本的内容，高亮标注差异（增加/删除/修改）
3. **Given** 对比模态框已打开, **When** 用户点击关闭按钮或模态框外部或按ESC键, **Then** 模态框关闭，返回到原来的版本树视图
4. **Given** 项目中只有一个版本, **When** 用户点击"对比"按钮, **Then** 系统提示"至少需要两个版本才能进行对比"

---

### User Story 2 - 重复内容提醒 (Priority: P2)

用户在创建新版本时，可能会无意中创建与已有版本内容完全相同的版本，导致数据冗余和版本树混乱。系统在用户保存新版本时，自动计算内容哈希值，检查是否存在相同内容的版本，如果存在则弹出提醒对话框，告知用户已有相同内容的版本（显示版本ID和创建时间），询问是否仍要创建。

**Why this priority**: 防止数据冗余，提升用户体验，避免版本树中出现大量重复版本。这是TECH 2.1和PRD 3.3中明确要求的功能。

**Independent Test**: 可以通过创建一个版本，然后尝试创建内容完全相同的子版本，验证系统是否弹出重复提醒来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户编辑了某个版本的内容, **When** 用户点击保存按钮创建新版本, **Then** 系统计算新内容的哈希值，检查项目中是否存在相同哈希值的版本
2. **Given** 新版本内容与已有版本A完全相同, **When** 保存操作触发, **Then** 系统弹出提醒对话框，显示"已存在相同内容的版本：[版本A的ID] (创建于 [时间])"，并提供"仍然创建"和"取消"两个选项
3. **Given** 重复提醒对话框已显示, **When** 用户选择"仍然创建", **Then** 系统创建新版本（允许用户有意创建重复版本）
4. **Given** 重复提醒对话框已显示, **When** 用户选择"取消", **Then** 取消保存操作，返回编辑状态
5. **Given** 新版本内容唯一, **When** 保存操作触发, **Then** 系统直接创建新版本，不显示提醒

---

### User Story 3 - 面板宽度调节 (Priority: P2)

用户在使用应用时，可能需要更大的编辑区域来查看长Prompt，或需要更大的版本树区域来查看复杂的分支结构。用户可以拖动中间主画布与右侧面板之间的分隔符，自由调整两个区域的相对宽度，以适应当前的工作需求。调整后的宽度比例会被记住，下次打开应用时保持相同布局。

**Why this priority**: 提供灵活的工作空间，适应不同的使用场景和个人偏好。这是UI文档2.0中明确要求的功能。

**Independent Test**: 可以通过在两个面板之间拖动分隔符，验证面板宽度是否随拖动而改变，刷新页面后验证宽度是否保持来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户看到主画布和右侧面板, **When** 用户将鼠标悬停在两个面板之间的边界上, **Then** 鼠标光标变为左右调整大小的图标（↔）
2. **Given** 鼠标光标已变为调整大小图标, **When** 用户按下鼠标并左右拖动, **Then** 分隔符跟随鼠标移动，两个面板的宽度实时调整
3. **Given** 用户正在拖动分隔符, **When** 用户释放鼠标, **Then** 分隔符固定在新位置，新的宽度比例被保存到本地存储
4. **Given** 用户已调整过面板宽度, **When** 用户刷新页面或重新打开应用, **Then** 面板宽度恢复到上次调整的比例
5. **Given** 用户拖动分隔符到极限位置, **When** 任一面板宽度小于预设最小值（如200px）, **Then** 分隔符停止移动，防止面板被完全压缩

---

### User Story 4 - 非叶子版本原地保存 (Priority: P3)

用户在查看某个中间版本（已有子版本的版本）时，发现内容需要修正或补充，但不希望创建新分支。用户修改内容后，使用原地保存快捷键（Ctrl+Shift+Enter）或点击"原地更新"按钮，直接修改当前版本的内容和更新时间，而不创建新版本。

**Why this priority**: 增强版本管理的灵活性，允许用户修正历史版本中的错误而不破坏版本树结构。这扩展了当前仅限叶子节点的原地保存功能。

**Independent Test**: 可以通过创建一个有子版本的父版本，修改父版本内容并使用原地保存，验证父版本内容是否被更新且未创建新版本来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户选中了一个有子版本的非叶子版本, **When** 用户修改其内容, **Then** "原地更新"按钮和快捷键Ctrl+Shift+Enter可用（不再受叶子节点限制）
2. **Given** 用户修改了非叶子版本的内容, **When** 用户按下Ctrl+Shift+Enter或点击"原地更新"按钮, **Then** 系统直接更新当前版本的content和updatedAt字段，不创建新版本
3. **Given** 非叶子版本被原地更新, **When** 更新完成, **Then** 版本树中该节点显示新的更新时间，子版本保持不变
4. **Given** 用户对非叶子版本使用普通保存（Ctrl+Enter）, **When** 保存操作触发, **Then** 系统仍然创建新的子版本（保留原有行为）

---

### User Story 5 - 版本树搜索 (Priority: P2)

用户在一个包含大量版本的项目中，需要快速定位包含特定关键词的版本。用户在版本树画布上方的搜索框中输入关键词，系统在整个版本树的所有版本内容中进行文本搜索，高亮显示所有匹配的版本节点，并在搜索框右侧显示匹配数量（如"3/10"表示第3个，共10个结果）。用户可以点击搜索框左右两侧的上一个/下一个按钮，在搜索结果之间跳转，画布自动滚动并聚焦到当前匹配的版本。

**Why this priority**: 在大型项目中快速定位特定版本，显著提升工作效率。这是版本管理工具的重要辅助功能。

**Independent Test**: 可以通过创建多个包含不同关键词的版本，在搜索框输入关键词，验证匹配版本是否被高亮并能通过按钮跳转来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在版本树视图中, **When** 用户在画布上方的搜索框中输入关键词, **Then** 系统实时搜索所有版本的content字段，高亮显示包含关键词的版本节点
2. **Given** 搜索已执行, **When** 有匹配结果, **Then** 搜索框右侧显示当前结果位置和总数（如"1/5"），画布自动滚动到第一个匹配版本并聚焦
3. **Given** 搜索结果显示"1/5", **When** 用户点击"下一个"按钮（→）, **Then** 画布滚动到第二个匹配版本，搜索框显示"2/5"
4. **Given** 搜索结果显示"5/5", **When** 用户点击"下一个"按钮, **Then** 画布循环跳转到第一个匹配版本，搜索框显示"1/5"
5. **Given** 搜索结果显示"1/5", **When** 用户点击"上一个"按钮（←）, **Then** 画布循环跳转到最后一个匹配版本，搜索框显示"5/5"
6. **Given** 用户输入了关键词, **When** 没有匹配结果, **Then** 搜索框显示"0/0"，无版本被高亮
7. **Given** 搜索框中有内容, **When** 用户清空搜索框, **Then** 所有高亮取消，画布恢复正常状态

---

### User Story 6 - 版本树画布控制优化 (Priority: P3)

用户在操作版本树时，需要方便地缩放和重置视图。用户可以在右侧面板的右下角找到画布控制按钮（放大、缩小、重置），点击这些按钮来调整画布的缩放级别和位置。同时，移除原先在右侧面板左下角的操作提示文字，使界面更加简洁。

**Why this priority**: 优化UI布局，提供更直观的画布控制方式，减少视觉干扰。这是UI改进的小幅优化。

**Independent Test**: 可以通过检查右侧面板右下角是否有控制按钮，点击验证缩放/重置功能，检查左下角操作提示是否被移除来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在版本树视图中, **When** 用户查看右侧面板的右下角, **Then** 显示三个画布控制按钮：放大（+）、缩小（-）、重置（⟲或适配图标）
2. **Given** 画布控制按钮已显示, **When** 用户点击放大按钮, **Then** 画布缩放级别增加（如从100%到125%）
3. **Given** 画布控制按钮已显示, **When** 用户点击缩小按钮, **Then** 画布缩放级别减少（如从100%到75%）
4. **Given** 画布已被缩放或平移, **When** 用户点击重置按钮, **Then** 画布恢复到默认缩放级别（100%）和初始位置（聚焦最新版本）
5. **Given** 用户查看右侧面板, **When** 检查左下角区域, **Then** 不再显示"🖱️ 拖拽画布平移 | 🔍 滚轮缩放 💡 点击节点查看版本内容"的操作提示文字

---

### Edge Cases

- 版本对比：如果两个版本内容完全相同，对比视图如何显示？（显示"两个版本内容相同"的提示）
- 重复提醒：如果用户修改了版本的元数据（评分、附件）但内容未变，是否触发重复提醒？（不触发，哈希只基于content字段）
- 面板宽度：如果窗口尺寸改变（缩小），保存的宽度比例是否会导致布局崩溃？（需要设置最小宽度限制和响应式调整）
- 非叶子版本保存：如果用户原地更新了父版本的内容，其哈希值是否会与子版本冲突？（允许，哈希去重只在创建新版本时检查，不影响原地更新）
- 版本搜索：如果搜索关键词包含特殊字符（如正则表达式元字符），系统如何处理？（进行字面匹配，转义特殊字符）
- 画布控制：如果用户在移动端使用，右下角的按钮是否会被手指遮挡或难以点击？（需要确保按钮尺寸符合触控最小尺寸44x44px）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在右侧面板的编辑器工具栏中提供"对比"按钮
- **FR-002**: 点击"对比"按钮后，系统必须弹出版本选择对话框，列出当前项目的所有版本（不包括当前选中版本）
- **FR-003**: 用户从对话框中选择另一个版本后，系统必须打开全屏或接近全屏的对比模态框
- **FR-004**: 对比模态框必须使用CodeMirror的@codemirror/merge扩展包实现并排（Side-by-Side）Diff视图
- **FR-005**: Diff视图必须清晰高亮显示两个版本之间的文本差异（增加、删除、修改）
- **FR-006**: 用户可以通过点击关闭按钮或按ESC键关闭对比模态框
- **FR-007**: 系统必须在versionStore的createVersion方法中实现contentHash计算（使用SHA-256或类似算法）
- **FR-008**: 创建新版本前，系统必须查询当前项目中是否存在相同contentHash的版本
- **FR-009**: 如果检测到重复内容，系统必须弹出提醒对话框，显示已存在版本的ID和创建时间
- **FR-010**: 重复提醒对话框必须提供"仍然创建"和"取消"两个选项
- **FR-011**: 用户选择"仍然创建"后，系统必须允许创建重复版本
- **FR-012**: 系统必须在主画布与右侧面板之间显示可拖动的分隔符
- **FR-013**: 用户拖动分隔符时，系统必须实时调整两个面板的宽度
- **FR-014**: 系统必须将调整后的宽度比例保存到本地存储（localStorage或IndexedDB）
- **FR-015**: 应用启动时，系统必须从本地存储读取并恢复上次的面板宽度比例
- **FR-016**: 系统必须设置面板的最小宽度限制（建议200px），防止面板被完全压缩
- **FR-017**: 系统必须移除当前仅限叶子节点的原地保存限制，允许所有版本使用原地保存功能
- **FR-018**: 用户对任意版本使用原地保存（Ctrl+Shift+Enter或点击"原地更新"按钮）时，系统必须直接更新该版本的content和updatedAt字段
- **FR-019**: 原地保存操作不得创建新版本，不得修改版本的父子关系
- **FR-020**: 系统必须在版本树画布上方提供搜索输入框
- **FR-021**: 用户输入关键词后，系统必须在当前项目的所有版本的content字段中进行文本搜索（不区分大小写）
- **FR-022**: 系统必须高亮显示所有匹配关键词的版本节点
- **FR-023**: 搜索框右侧必须显示当前结果位置和总数（如"3/10"）
- **FR-024**: 搜索框必须提供"上一个"和"下一个"导航按钮
- **FR-025**: 点击"下一个"按钮时，画布必须自动滚动并聚焦到下一个匹配版本
- **FR-026**: 点击"上一个"按钮时，画布必须自动滚动并聚焦到上一个匹配版本
- **FR-027**: 在第一个结果时点击"上一个"，或在最后一个结果时点击"下一个"，系统必须循环跳转
- **FR-028**: 清空搜索框时，系统必须取消所有高亮，恢复画布正常状态
- **FR-029**: 系统必须将画布控制按钮（放大、缩小、重置）移动到右侧面板的右下角
- **FR-030**: 系统必须移除右侧面板左下角的操作提示文字"🖱️ 拖拽画布平移 | 🔍 滚轮缩放 💡 点击节点查看版本内容"
- **FR-031**: 放大/缩小按钮必须调整画布的缩放级别（建议步进25%）
- **FR-032**: 重置按钮必须恢复画布到默认缩放级别（100%）和初始位置

### Key Entities

- **CompareRequest**: 表示一次版本对比请求
  - sourceVersionId: 发起对比的版本ID
  - targetVersionId: 被选择用于对比的版本ID
  
- **SearchState**: 表示版本树搜索的状态
  - query: 搜索关键词
  - matches: 匹配的版本ID列表
  - currentIndex: 当前聚焦的匹配结果索引
  
- **LayoutPreference**: 表示用户的布局偏好设置
  - canvasPanelWidthRatio: 主画布与右侧面板的宽度比例（如0.6表示主画布占60%）

### Data Model Changes

- **Version**: 扩展现有Version模型
  - contentHash: 已存在但未实现计算，需要在createVersion时计算和填充
  - 无需新增字段，但需要确保contentHash字段被正确使用

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在3次点击内完成两个版本的对比操作（点击对比按钮 → 选择版本 → 查看对比结果）
- **SC-002**: 系统能在500ms内完成contentHash计算和重复检查（针对10KB以内的Prompt内容）
- **SC-003**: 面板宽度调整操作响应时间小于16ms（保持60fps流畅度）
- **SC-004**: 搜索功能能在200ms内完成100个版本的全文搜索并高亮结果
- **SC-005**: 用户调整面板宽度后，刷新页面时宽度保持率达到100%（每次都能恢复）
- **SC-006**: 非叶子版本原地保存操作不会创建任何新版本节点（版本树节点数不变）
- **SC-007**: 版本搜索结果的跳转操作能在100ms内完成画布滚动和聚焦
- **SC-008**: 重复内容检测的准确率达到100%（相同内容必定触发提醒，不同内容必不触发）

## Assumptions

- 用户浏览器支持现代Web API（crypto.subtle用于SHA-256计算，ResizeObserver用于面板拖动）
- 单个项目的版本数量通常不超过1000个（影响搜索性能设计）
- 用户主要在桌面端使用此功能（移动端的拖动分隔符体验可能受限）
- 搜索功能执行简单的文本匹配，不支持复杂的正则表达式或模糊匹配
- contentHash只基于版本的content字段计算，不包括元数据（评分、附件）
- 面板宽度比例保存在localStorage中，不同设备间不同步
- 画布控制按钮的图标使用Material Design Icons或应用已有的图标库
