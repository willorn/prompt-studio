## 交互规范：草稿/自动保存与恢复（Drafts）

版本：1.1  
日期：2026-01-17

### 1. 目标

- 在任何异常场景（误关页面、浏览器崩溃、误操作切换等）下，用户的编辑内容不应丢失。
- 草稿恢复必须提供足够的“决策信息”（时间、版本信息、可查看差异），避免用户在不确定的情况下做选择。
- 降低认知负担：默认不展示复杂的 `+/-` 行级预览；差异查看作为可选动作。
- 对“切换版本/项目”这类高风险操作提供防错默认：用户未明确决策前，不应改变上下文。

### 2. 术语

- 版本快照（Snapshot）：当前版本在数据库中的 `content/name/updatedAt`。
- 草稿（Draft）：用户在编辑器中尚未保存到版本库的内容（`editorContent + versionName`），持久化存储。
- 基准版本（Base）：草稿生成时对应的版本快照（用于判断是否产生冲突/提示用户）。

### 3. 存储策略（按 projectId + versionId 分桶）

- 分桶维度：`projectId + versionId`。
  - `versionId` 为空时使用固定占位（例如 `__new__`），避免“未选版本/新建草稿”丢失。
- 草稿字段（最少集）：
  - `content`, `versionName`, `draftUpdatedAt`
  - `baseUpdatedAt`（可选）与 `baseContentHash`（必选，用于提示“草稿基于旧快照”且避免误报）
- 草稿必须跨页面刷新/关闭保留，除非用户明确执行“丢弃草稿”或“保存成功后自动清理（本桶）”。

### 4. 自动保存触发（Dirty 时定期落盘）

- 触发条件：`isDirty = true` 且存在 `currentProjectId`。
- 频率控制：
  - 防抖（用户停止输入后 X ms 写入，建议 800~1200ms）
  - 节流（持续输入时每 Y 秒强制落盘一次，建议 5s）
- 注意：不要依赖 `beforeunload` 才落盘；退出时机不可靠。
- 关键防误报规则：当“版本刚加载/切换中”导致的短暂 dirty 出现时，不应写入草稿（否则会产生空草稿，刷新后误提示）。
  - 实现建议：仅当编辑器已完成对当前 `projectId+versionId` 的快照应用后，才允许自动保存草稿。

### 5. 恢复草稿的触发时机（按场景区分）

当检测到同桶草稿且与快照存在差异时，需要提示用户决策。但不同触发时机的“打扰强度”不同：

#### 5.1 Boot：刷新/进入版本（非阻塞 Banner）

刷新/重新进入页面后，默认加载“版本快照”（不自动恢复草稿），并在编辑区上方显示非阻塞 Banner：

- 标题：发现上次未保存内容
- 必须展示的信息：
  - 版本快照：名称/短 ID（可选）+ `updatedAt`（格式化到分钟）
  - 草稿：`draftUpdatedAt`（格式化到分钟）
  - 若检测到基准变化（`draft.baseContentHash !== hash(snapshot.content)`）：展示提示“此版本在你上次编辑后已发生变化，建议先查看差异再决定”
- 操作按钮与语义：
  - `继续编辑`：将编辑器切换到草稿内容（用户显式触发才恢复）
  - `放弃更改`：删除草稿并保留当前已保存版本（快照）
  - `查看差异`：打开完整差异对比（左=版本快照，右=草稿）
  - `关闭`：仅关闭提示条（不删除草稿；本次会话内不再打扰，刷新后仍可再次提示）

#### 5.2 Switch：切换版本/切换项目（阻塞 Dialog）

当用户主动“切换到某个版本/项目”时，如果目标版本存在草稿且与快照存在差异，必须阻塞决策（避免用户切走后丢失上下文）：

- 必须展示的信息同 Banner（快照时间/草稿时间/基准变化提示）
- 操作按钮与语义（用“打开”描述，避免用户误解“恢复/丢弃”）：
  - `带未保存内容打开`：应用草稿并打开目标版本
  - `不带未保存内容打开`：删除草稿并打开目标版本快照
  - `暂不切换`：取消本次切换（什么都不动）
  - `查看差异`：打开完整差异对比（左=版本快照，右=草稿）

### 6. 防错默认：稍后决定必须阻止切换（B）

#### 6.1 规则

当对话框由“切换版本/切换项目”触发时，用户点击 `暂不切换`：

- 必须取消本次切换（不进入目标版本/项目）。
- 编辑器与上下文保持切换前状态不变（“什么都不动”）。
- 草稿保留。

#### 6.2 原因（必须写入规范）

- 用户需要为“切换”负责；如果系统允许在“未明确决策草稿去留”的情况下继续切换，用户很可能切到目标后直接关闭页面或开始其他操作，从而产生“草稿丢了/找不到”的常识性错误体验。
- 产品应默认防错：除非用户明确选择“恢复/丢弃/（未来可选）继续切换但不恢复草稿”，否则不应改变上下文。

#### 6.3 可选增强（未来）

- 若确实需要支持继续切换，必须提供明确按钮：`继续切换（不恢复草稿）`，并在按钮文案附近提示“草稿仍保留，可稍后从入口恢复”，避免用户误解。
