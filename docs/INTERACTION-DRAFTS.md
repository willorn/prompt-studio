## 交互规范：草稿/自动保存与恢复（Drafts）

版本：1.0  
日期：2026-01-16

### 1. 目标

- 在任何异常场景（误关页面、浏览器崩溃、误操作切换等）下，用户的编辑内容不应丢失。
- 草稿恢复必须提供足够的“决策信息”（时间、差异预览、可展开完整对比），避免用户在不确定的情况下做选择。
- 对“切换版本/项目”这类高风险操作提供防错默认：用户未明确决策前，不应改变上下文。

### 2. 术语

- 版本快照（Snapshot）：当前版本在数据库中的 `content/name/updatedAt`。
- 草稿（Draft）：用户在编辑器中尚未保存到版本库的内容（`editorContent + versionName`），持久化存储。
- 基准版本（Base）：草稿生成时对应的版本快照（用于判断是否产生冲突/提示用户）。

### 3. 存储策略（按 projectId + versionId 分桶）

- 分桶维度：`projectId + versionId`。
  - `versionId` 为空时使用固定占位（例如 `__new__`），避免“未选版本/新建草稿”丢失。
- 草稿字段（最少集）：
  - `content`, `versionName`, `draftUpdatedAt`
  - `baseUpdatedAt` 或 `baseContentHash`（用于提示“草稿基于旧快照”）
- 草稿必须跨页面刷新/关闭保留，除非用户明确执行“丢弃草稿”或“保存成功后自动清理（本桶）”。

### 4. 自动保存触发（Dirty 时定期落盘）

- 触发条件：`isDirty = true` 且存在 `currentProjectId`。
- 频率控制：
  - 防抖（用户停止输入后 X ms 写入，建议 800~1200ms）
  - 节流（持续输入时每 Y 秒强制落盘一次，建议 5s）
- 注意：不要依赖 `beforeunload` 才落盘；退出时机不可靠。

### 5. 恢复草稿弹窗（必须提供决策细节）

当准备加载某版本快照到编辑器前，若检测到同桶草稿且与快照存在差异，弹出恢复草稿弹窗。

#### 5.1 必须展示的信息

- 基准版本信息（旧版本快照）：
  - 版本名称/短 ID（可选）
  - `updatedAt`（格式化到分钟）
- 草稿信息：
  - 草稿最后保存时间 `draftUpdatedAt`（格式化到分钟）
- 差异摘要：
  - 版本名变化：`"旧名称" -> "新名称"`（若有）
  - 内容变化：新增行数/删除行数（用于快速判断改动规模）
- 差异预览（用户要求）：
  - 统一 Diff 文本（类似 git diff），以 `+`/`-` 行展示，默认截断到 N 行（例如 60 行），可滚动
  - 提供“展开查看完整差异”入口（建议用 Monaco DiffEditor 并排对比：左=版本快照，右=草稿）

#### 5.2 按钮与语义（核心防错规则）

- `恢复草稿`：将编辑器内容/版本名替换为草稿内容（草稿可选择保留或清理，需在实现时统一规则）。
- `丢弃草稿`：删除草稿并继续加载版本快照。
- `稍后决定`：保留草稿，关闭弹窗，并遵循下面的“阻止切换”规则。

### 6. 防错默认：稍后决定必须阻止切换（B）

#### 6.1 规则

当弹窗由“切换版本/切换项目”触发时，用户点击 `稍后决定`：

- 必须取消本次切换（不进入目标版本/项目）。
- 编辑器与上下文保持切换前状态不变（“什么都不动”）。
- 草稿保留。

#### 6.2 原因（必须写入规范）

- 用户需要为“切换”负责；如果系统允许在“未明确决策草稿去留”的情况下继续切换，用户很可能切到目标后直接关闭页面或开始其他操作，从而产生“草稿丢了/找不到”的常识性错误体验。
- 产品应默认防错：除非用户明确选择“恢复/丢弃/（未来可选）继续切换但不恢复草稿”，否则不应改变上下文。

#### 6.3 可选增强（未来）

- 若确实需要支持继续切换，必须提供明确按钮：`继续切换（不恢复草稿）`，并在按钮文案附近提示“草稿仍保留，可稍后从入口恢复”，避免用户误解。

